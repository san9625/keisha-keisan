<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <title>傾斜くん - 飲み会の傾斜割り勘計算ツール</title>
  <meta name="description" content="飲み会の割り勘を傾斜計算。「飲み会　傾斜」は傾斜くんにお任せ。合計金額と人数を入れるだけの簡単操作。" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="傾斜くん - 飲み会の傾斜割り勘計算ツール" />
  <meta property="og:description" content="飲み会の割り勘を傾斜計算。「飲み会　傾斜」は傾斜くんにお任せ。合計金額と人数を入れるだけの簡単操作。" />
  <meta property="og:url" content="https://keisha.sakuraproduct.com/" />
  <meta property="og:image" content="https://keisha.sakuraproduct.com/assets/ogp.png" />
  <meta property="og:site_name" content="傾斜くん" />
  <meta property="og:locale" content="ja_JP" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="傾斜くん - 飲み会の傾斜割り勘計算ツール" />
  <meta name="twitter:description" content="飲み会の割り勘を傾斜計算。「飲み会　傾斜」は傾斜くんにお任せ。合計金額と人数を入れるだけの簡単操作。" />
  <meta name="twitter:image" content="https://keisha.sakuraproduct.com/assets/ogp.png" />
  <style>
    :root {
      --bg: #ffffff;
      --card: rgba(255, 255, 255, 0.97);
      --card2: rgba(246, 248, 255, 0.94);
      --txt: rgba(31, 42, 68, 0.95);
      --muted: rgba(31, 42, 68, 0.64);
      --muted2: rgba(31, 42, 68, 0.52);
      --border: rgba(47, 115, 255, 0.18);
      --accent: rgba(47, 115, 255, 0.96);
      --lime: rgba(184, 241, 113, 0.9);
      --danger: rgba(243, 132, 94, 0.94);
      --ok: rgba(38, 160, 130, 0.92);
      --shadow: 0 12px 36px rgba(25, 45, 90, 0.16);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans JP", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--txt);
      background: var(--bg);
      min-height: 100svh;
      overflow-x: hidden;
    }

    .wrap { max-width: 980px; width: 100%; margin: 0 auto; padding: 18px 16px 40px; }
    header {
      padding: 10px 4px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 4px 0 10px;
      gap: 8px;
    }
    .logo img {
      height: 44px;
      width: auto;
    }
    @media (max-width: 520px) {
      .logo img { height: 36px; }
    }
    h1 {
      margin: 6px 0 6px;
      font-size: 20px;
      letter-spacing: 0.2px;
      line-height: 1.25;
    }
    .sub {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
    .eyebrow {
      display: inline-block;
      margin: 0 0 6px;
      padding: 4px 10px;
      color: rgba(31,42,68,0.82);
      background: rgba(235,240,255,0.92);
      border: 1px solid rgba(47,115,255,0.22);
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    .sub.lead {
      color: rgba(32,42,80,0.82);
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    @media (min-width: 860px) {
      .grid { grid-template-columns: 1.05fr 0.95fr; }
    }

    .card {
      width: 100%;
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .card h2 {
      font-size: 15px;
      margin: 0 0 12px;
      color: rgba(32,42,80,0.88);
    }

    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 520px) {
      .row { grid-template-columns: 1fr 1fr; }
    }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, button {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(249, 251, 255, 0.94);
      color: var(--txt);
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    input:focus, select:focus {
      border-color: rgba(47,115,255,0.82);
      box-shadow: 0 0 0 3px rgba(47,115,255,0.24);
    }

    .btnrow {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    button {
      cursor: pointer;
      background: rgba(47,115,255,0.10);
      border-color: rgba(47,115,255,0.32);
      font-weight: 600;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      box-shadow: 0 6px 18px rgba(25, 55, 120, 0.12);
    }
    button.primary {
      background: linear-gradient(135deg, rgba(47,115,255,0.96), rgba(36,108,240,0.9));
      color: #fff;
      border-color: rgba(47,115,255,0.9);
      box-shadow: 0 8px 24px rgba(25, 55, 120, 0.24);
    }
    button.secondary {
      background: rgba(255,255,255,0.94);
      border-color: rgba(47,115,255,0.2);
      font-weight: 600;
    }
    button.danger {
      background: rgba(255, 224, 210, 0.5);
      border-color: rgba(243,132,94,0.55);
    }
    button:hover { box-shadow: 0 10px 26px rgba(28, 62, 130, 0.22); }
    button:active { transform: translateY(1px); }
    button:focus-visible { box-shadow: 0 0 0 4px rgba(47,115,255,0.28); }

    .ranks {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }
    .rankline {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(47,115,255,0.18);
      background: rgba(255,255,255,0.9);
    }
    .tag {
      font-size: 12px;
      color: rgba(31,42,68,0.78);
      border: 1px solid rgba(47,115,255,0.26);
      background: rgba(184,241,113,0.22);
      padding: 8px 10px;
      border-radius: 999px;
      text-align: center;
      user-select: none;
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.55;
    }

    .err {
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(243,132,94,0.6);
      background: rgba(255, 228, 218, 0.94);
      color: rgba(156, 60, 32, 0.92);
      font-size: 13px;
      line-height: 1.5;
    }

    .resultbox {
      border-radius: 16px;
      border: 1px solid rgba(47,115,255,0.16);
      background: rgba(255,255,255,0.94);
      overflow: hidden;
      transition: box-shadow 0.18s ease, transform 0.18s ease;
    }
    .resultbox.is-ready {
      box-shadow: 0 14px 36px rgba(45, 60, 120, 0.16);
      transform: translateY(-2px);
    }
    .resulthead {
      padding: 12px 14px;
      display: grid;
      gap: 6px;
      border-bottom: 1px solid rgba(47,115,255,0.16);
      background: rgba(235,242,255,0.94);
    }
    .resulthead .big {
      font-size: 14px;
      color: rgba(32,42,80,0.9);
      font-weight: 700;
    }
    .resulthead .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .resulthead .pill-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(184,241,113,0.22);
      color: rgba(31,42,68,0.86);
      border: 1px solid rgba(47,115,255,0.26);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      width: fit-content;
    }

    .table-wrap { overflow: auto; max-height: 340px; }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 100%;
    }
    th, td {
      padding: 11px 12px;
      border-bottom: 1px solid rgba(90,123,255,0.13);
      text-align: left;
      font-size: 14px;
    }
    th {
      font-size: 12px;
      color: rgba(32,42,80,0.62);
      font-weight: 600;
      letter-spacing: 0.2px;
      position: sticky;
      top: 0;
      background: rgba(235,242,255,0.98);
    }
    td.num, th.num { text-align: right; font-variant-numeric: tabular-nums; }

    tbody tr:nth-child(odd) { background: rgba(235,242,255,0.62); }
    tbody tr:hover { background: rgba(47,115,255,0.08); }

    .sumline {
      padding: 12px 14px;
      display: grid;
      gap: 6px;
      background: rgba(236,240,255,0.8);
    }
    .sumline .ok { color: var(--ok); font-weight: 700; }
    .sumline .muted { color: var(--muted2); font-size: 12px; line-height: 1.5; }

    footer {
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.6;
      padding: 0 4px;
    }

    .pillrow {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }
    .pill {
      font-size: 12px;
      color: rgba(32,42,80,0.7);
      border: 1px solid rgba(90,123,255,0.20);
      background: rgba(228,236,255,0.9);
      padding: 6px 10px;
      border-radius: 999px;
    }
    .logic-box {
      margin-top: 12px;
      border: 1px solid rgba(47,115,255,0.16);
      border-radius: 12px;
      background: rgba(240,244,255,0.94);
      padding: 10px 12px;
    }
    .logic-box summary {
      cursor: pointer;
      font-size: 13px;
      color: rgba(32,42,80,0.82);
      font-weight: 600;
      list-style: none;
    }
    .logic-box summary::-webkit-details-marker { display: none; }
    .logic-box summary::before {
      content: "ℹ";
      display: inline-block;
      margin-right: 6px;
      color: rgba(47,115,255,0.9);
      font-weight: 700;
    }
    .logic-box p {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }
    .logic-box ul {
      margin: 6px 0 0 16px;
      padding: 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
    }
  </style>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "傾斜くん",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "description": "飲み会の割り勘を傾斜計算。「飲み会　傾斜」は傾斜くんにお任せ。合計金額と人数を入れるだけの簡単操作。",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "JPY"
      },
      "featureList": [
        "傾斜計算",
        "飲み会の傾斜計算",
        "合計金額と人数入力だけで計算",
        "結果をスクリーンショットで保存しやすい表示"
      ],
      "keywords": "傾斜割り勘, 飲み会, 傾斜計算, 飲み会の傾斜計算, 割り勘, スマホ対応"
    }
  </script>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Organization",
          "name": "Keisha (傾斜くん)",
          "url": "https://keisha.sakuraproduct.com/",
          "logo": "https://keisha.sakuraproduct.com/assets/logo.png"
        },
        {
          "@type": "FAQPage",
          "mainEntity": [
            {
              "@type": "Question",
              "name": "サービスの使い方は？",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "合計金額を入力し、傾斜率（鬼・松・竹・梅・平等）を選択。ランク別人数を入力し、「計算する」を押すだけで結果が表示されます。結果はスクショで保存してください。"
              }
            },
            {
              "@type": "Question",
              "name": "計算ロジックの概要",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "ランク1を基準に、鬼・松・竹・梅・平等で設定されたベース値を指数的に減衰させて重みを作り、合計金額を公平に配分しています。人数0のランクは除外し、重み合計を算出。合計金額 ÷ 重み合計 = 単位額を計算。各ランクの支払額は「単位額 × 重み」をいったん切り捨て。端数は小数部が大きい・高ランク優先で1円ずつ再配分し合計を一致させる。最終的に合計が入力金額と一致することをチェックします。"
              }
            },
            {
              "@type": "Question",
              "name": "端数は誰が負担しますか？",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "端数は小数部が大きい順かつ高ランク優先で1円ずつ配分し、高ランク側が先に負担します。"
              }
            },
            {
              "@type": "Question",
              "name": "鬼設定はどのくらい差がつきますか？",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "傾斜率のベースを1.6にした最も差が大きい設定で、高ランクほど多く支払う計算になります。"
              }
            },
            {
              "@type": "Question",
              "name": "傾斜率の違いは？（鬼・松・竹・梅・平等）",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "鬼=ベース1.6で差が最大、松=1.4、竹=1.2（標準）、梅=1.15（差が小さい）、平等=1.0（完全等分）です。ランクが下がるほど支払額を小さくしますが、平等を選べば全員同額になります。"
              }
            },
            {
              "@type": "Question",
              "name": "人数が0のランクはどうなりますか？",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "0人のランクは自動的に計算対象から除外され、重み合計にも含まれません。"
              }
            },
            {
              "@type": "Question",
              "name": "入力したデータは保存されますか？",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "ローカルで計算する静的ページのため、入力値はサーバに保存されません。"
              }
            }
          ]
        }
      ]
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">
        <img src="https://keisha.sakuraproduct.com/assets/logo.png" alt="傾斜くん" />
      </div>
      <h1>傾斜くん - 飲み会の傾斜割り勘計算</h1>
      <p class="sub lead">人数と合計金額を入れるだけのシンプル操作！</p>
      <div class="pillrow" aria-label="主な機能">
        <span class="pill">合計金額と人数を入力するだけ30秒！</span>
        <span class="pill">傾斜率は鬼・松・竹・梅・平等から選択可能</span>
      </div>
    </header>
    <div class="grid">
      <section class="card" aria-label="入力">
        <h2>入力</h2>

        <div class="row">
          <div>
            <label for="total">合計金額（円）</label>
            <input id="total" inputmode="decimal" pattern="[0-9]*" placeholder="例）35000" aria-describedby="totalHint" />
            <div id="totalHint" class="hint">数字のみ入力してください。</div>
          </div>
          <div>
            <label for="slope">傾斜率</label>
            <select id="slope">
              <option value="super">鬼（差が最大）</option>
              <option value="steep">松（差が大きい）</option>
              <option value="normal" selected>竹（標準）</option>
              <option value="gentle">梅（差が小さい）</option>
              <option value="equal">平等（等分）</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="rounding">丸め単位</label>
            <select id="rounding">
              <option value="1">一円単位</option>
              <option value="100" selected>百円単位</option>
              <option value="1000">千円単位</option>
            </select>
          </div>
        </div>

        <div class="hint">
          ランクは <b>1が偉い（多く支払う）</b>想定です。人数が0（未入力）のランクは計算から除外されます。役職やランクが離れている場合は、特定のランクをスキップできます。
        </div>

        <div style="margin-top:12px;">
          <label>ランク別人数</label>
          <div id="ranks" class="ranks"></div>

          <div class="btnrow">
            <button id="addRank" type="button" class="secondary">＋ ランクを追加（最大10）</button>
            <button id="reset" type="button" class="danger">リセット</button>
          </div>

          <div class="btnrow" style="grid-template-columns: 1fr;">
            <button id="calc" type="button" class="primary">計算する</button>
          </div>

          <div id="err" class="err" role="alert" aria-live="polite"></div>
        </div>
      </section>

      <section class="card" aria-label="結果">
        <h2>結果</h2>

        <div class="resultbox" id="resultBox">
          <div class="resulthead">
            <div class="big">各ランク 1人あたりの支払い額</div>
            <div class="pill-badge" id="slopeBadge" aria-live="polite"></div>
            <div class="pill-badge" id="roundingBadge" aria-live="polite"></div>
            <div class="small">計算後に結果を表示します。</div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ランク</th>
                  <th class="num">人数</th>
                  <th class="num">1人あたり（円）</th>
                  <th class="num">小計（円）</th>
                </tr>
              </thead>
              <tbody id="resultBody">
                <tr>
                  <td colspan="4" style="color: rgba(32,42,80,0.52); font-size: 13px;">
                    まだ計算していません。入力して「計算する」を押してください。
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="sumline">
            <div id="sumText" class="ok">合計：—</div>
            <div id="sumNote" class="muted">※結果はスクリーンショットで保存してください。</div>
          </div>
        </div>
      </section>
    </div>
    <section class="card" aria-label="よくある質問" style="margin-top:12px;">
      <h2>よくある質問</h2>
      <details class="logic-box" open>
        <summary>サービスの使い方は？</summary>
        <p>以下の手順ですぐに計算できます。</p>
        <ul>
          <li>合計金額を入力</li>
          <li>傾斜率（鬼・松・竹・梅・平等）を選択。デフォルトは竹（標準）です。</li>
          <li>ランク別人数を入力。その場で役職やランクが一番高い人をランク１に設定してください。役職やランクが離れている場合は、特定のランクをスキップできます。スキップすることで傾斜はより急になります。</li>
          <li>「計算する」を押す</li>
          <li>結果をスクショで保存する</li>
        </ul>
      </details>
      <details class="logic-box">
        <summary>計算ロジックの概要</summary>
          <p>ランク1を基準に、鬼・松・竹・梅・平等で設定されたベース値を指数的に減衰させて重みを作り、合計金額を公平に配分しています。</p>
        <ul>
          <li>人数0のランクは除外し、重み合計を算出</li>
          <li>合計金額 ÷ 重み合計 = 単位額を計算</li>
          <li>各ランクの支払額は「単位額 × 重み」をいったん切り捨て</li>
          <li>端数は小数部が大きい・高ランク優先で1円ずつ再配分し合計を一致させる</li>
          <li>最終的に合計が入力金額と一致することをチェック</li>
        </ul>
      </details>
      <details class="logic-box">
        <summary>端数は誰が負担しますか？</summary>
        <p>端数は小数部が大きい順かつ高ランク優先で1円ずつ配分し、高ランク側が先に負担します。</p>
      </details>
      <details class="logic-box">
        <summary>合計が入力金額を上回ることはありますか？</summary>
        <p>丸め単位が100円・1000円などで割り切れない場合、最上位ランクの1人あたり額を上乗せして端数を吸収するため、入力合計より数円～数十円程度上回ることがあります。</p>
      </details>
      <details class="logic-box">
        <summary>鬼設定はどのくらい差がつきますか？</summary>
        <p>傾斜率ベース1.6の最も差が大きい設定で、高ランクほど多く支払う計算になります。</p>
      </details>
      <details class="logic-box">
          <summary>傾斜率の違いは？（鬼・松・竹・梅・平等）</summary>
          <p>鬼=ベース1.6で差が最大、松=1.4、竹=1.2（標準）、梅=1.15（差が小さい）、平等=1.0（完全等分）です。ランクが下がるほど支払額を少なくしますが、平等を選べば全員同額になります。</p>
      </details>
      <details class="logic-box">
        <summary>人数が0のランクはどうなりますか？</summary>
        <p>人数0のランクは計算対象から自動で除外され、重み合計に含まれません。</p>
      </details>
      <details class="logic-box">
        <summary>入力したデータは保存されますか？</summary>
        <p>このページは静的に動作し、入力値はサーバへ送信・保存されません。</p>
      </details>
    </section>
  </div>

  <script>
    // ----- 設定 -----
    const DEFAULT_RANKS = 5;
    const MAX_RANKS = 10;

    // 傾斜率：指数のベース（大きいほど差が大きい）
    // rank 1（偉い）: weight=1
    // rank が大きいほど weight が減る => 支払いが少なくなる
    const SLOPE_BASE = {
      super: 1.6,
      steep: 1.4,
      normal: 1.2,
      gentle: 1.15,
      equal: 1.0,
    };

    const SLOPE_LABELS = {
      super: "鬼（差が最大）",
      steep: "松（差が大きい）",
      normal: "竹（標準）",
      gentle: "梅（差が小さい）",
      equal: "平等（等分）",
    };

    // ----- ユーティリティ -----
    const yen = (n) => {
      if (!Number.isFinite(n)) return "—";
      return n.toLocaleString("ja-JP");
    };

    const parseYen = (s) => {
      if (typeof s !== "string") return NaN;
      const cleaned = s.replace(/[^\d]/g, "");
      return cleaned ? Number(cleaned) : NaN;
    };

    const clampInt = (n, min, max) => Math.min(max, Math.max(min, n));

    // ----- UI生成 -----
    const ranksEl = document.getElementById("ranks");
    const totalEl = document.getElementById("total");
    const slopeEl = document.getElementById("slope");
    const roundingEl = document.getElementById("rounding");
    const errEl = document.getElementById("err");

    const resultBodyEl = document.getElementById("resultBody");
    const sumTextEl = document.getElementById("sumText");
    const sumNoteEl = document.getElementById("sumNote");
    const slopeBadgeEl = document.getElementById("slopeBadge");
    const roundingBadgeEl = document.getElementById("roundingBadge");
    const resultBoxEl = document.getElementById("resultBox");

    let rankCount = DEFAULT_RANKS;

    function makeRankLine(rank) {
      const wrap = document.createElement("div");
      wrap.className = "rankline";

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = `ランク ${rank}`;

      const input = document.createElement("input");
      input.type = "text";
      input.inputMode = "decimal";
      input.pattern = "[0-9]*";
      input.placeholder = "人数（例）3";
      input.dataset.rank = String(rank);
      input.setAttribute("aria-label", `ランク${rank}の人数`);

      // スマホで扱いやすいよう、タップで全選択
      input.addEventListener("focus", () => {
        setTimeout(() => input.select(), 0);
      });

      wrap.appendChild(tag);
      wrap.appendChild(input);
      return wrap;
    }

    function renderRanks() {
      ranksEl.innerHTML = "";
      for (let r = 1; r <= rankCount; r++) {
        ranksEl.appendChild(makeRankLine(r));
      }
    }

    function showError(msg) {
      if (!msg) {
        errEl.style.display = "none";
        errEl.textContent = "";
        return;
      }
      errEl.style.display = "block";
      errEl.textContent = msg;
    }

    function updateSlopeBadge(key) {
      const label = SLOPE_LABELS[key] || SLOPE_LABELS.normal;
      if (slopeBadgeEl) {
        slopeBadgeEl.textContent = `傾斜率：${label}`;
      }
    }

    function updateRoundingBadge(unit) {
      if (!roundingBadgeEl) return;
      const label = Number(unit) === 1 ? "一円単位" : `${yen(Number(unit))}円単位`;
      roundingBadgeEl.textContent = `丸め単位：${label}`;
      if (sumNoteEl) {
        sumNoteEl.textContent = `丸め単位：${label} ／ 結果はスクリーンショットで保存してください。`;
      }
    }

    // ----- 計算ロジック -----
    function getWeights(base, count) {
      const weights = [];
      for (let r = 1; r <= count; r++) {
        const w = Math.pow(base, -(r - 1)); // rank1=1, rankが上がるほど小さくする
        weights.push(w);
      }
      return weights;
    }

    function readPeopleCounts() {
      const inputs = ranksEl.querySelectorAll("input[data-rank]");
      const counts = [];
      inputs.forEach((inp) => {
        const n = parseYen(inp.value);
        counts.push(Number.isFinite(n) ? clampInt(n, 0, 9999) : 0);
      });
      return counts;
    }

    function gcd(a, b) {
      while (b !== 0) {
        const t = a % b;
        a = b;
        b = t;
      }
      return a;
    }

    function compute(total, counts, weights, roundingUnit) {
      const unitStep = Math.max(1, Math.floor(roundingUnit));

      // 対象：人数>0 のランクのみ
      const active = [];
      for (let i = 0; i < counts.length; i++) {
        if (counts[i] > 0) active.push(i);
      }
      if (active.length === 0) {
        throw new Error("人数が1人も入力されていません。少なくとも1つのランクに人数を入力してください。");
      }

      // 端数は最上位ランクが1円単位で負担し、それ以外は丸め単位で処理する
      const topIdx = active[0];
      const steps = counts.map((_, i) => (i === topIdx ? 1 : unitStep));

      // 重み合計（人数×重み）
      let W = 0;
      for (const i of active) W += counts[i] * weights[i];
      if (W <= 0) throw new Error("入力値が不正です。");

      const unit = total / W;

      // まずは floor で仮計算
      const pay = new Array(counts.length).fill(0);
      let subtotal = 0;

      // 端数調整のための候補（小数部が大きい順に +1 したい）
      const fracs = []; // {i, frac}

      for (const i of active) {
        const raw = unit * weights[i];
        const step = steps[i];
        const flo = Math.floor(raw / step) * step;
        pay[i] = flo;
        subtotal += flo * counts[i];

        const frac = raw - flo;
        fracs.push({ i, frac });
      }

      // 合計との差分を 1円ずつ配分して一致させる
      let diff = total - subtotal;

      // diff > 0 のとき：加算が必要
      // 1円加算の効果は「そのランク人数分」増えるので、
      // (人数が多いほど一気に増える) -> 端数調整は難しいが、今回は
      // 「高ランク側を優先しつつ、実際に合計一致するまで」分配する。
      // 具体的には：候補順（小数部大きい→rank高い優先）で1円ずつ加算し、
      // 合計が超えそうなら別候補に回す（最大反復で収束）。
      //
      // ※人数が多いと1円加算で一気に増えるため、厳密な最適化より
      // “実用上の分かりやすさ”を優先した手法です。

      // 優先順：小数部 desc -> rank desc（高いランクほど優先）
      fracs.sort((a, b) => {
        if (b.frac !== a.frac) return b.frac - a.frac;
        return a.i - b.i; // 同率なら上位ランク優先で端数を負担
      });

      // 安全策：無限ループ防止
      let guard = 0;
      const GUARD_MAX = 200000;

      while (diff !== 0 && guard < GUARD_MAX) {
        guard++;

        if (diff > 0) {
          // 1円足してもよい候補を探す
          let advanced = false;

          for (const c of fracs) {
            const i = c.i;
            const step = counts[i] * steps[i]; // このランクを steps[i] 円上げると合計は人数分増える
            if (step <= 0) continue;

            // 超過しない範囲で足す（最優先）
            if (diff - step >= 0) {
              pay[i] += steps[i];
              diff -= step;
              advanced = true;
              break;
            }
          }

          // どれも step が大きくて diff を埋められない場合はループを抜けて後段でトップランク調整
          if (!advanced) break;
        } else {
          // diff < 0 のとき：減算が必要（払いすぎ）
          // 優先順：小数部が小さい（=切り捨て損が少ない）-> rank低い（安い側）から下げる
          const order = fracs.slice().sort((a, b) => {
            if (a.frac !== b.frac) return a.frac - b.frac;
            return a.i - b.i;
          });

          let advanced = false;
          for (const c of order) {
            const i = c.i;
            const step = counts[i] * steps[i];
            if (step <= 0) continue;

            // 1円下げられる範囲（マイナス支払いは不可）
            if (pay[i] > 0) {
              pay[i] -= steps[i];
              diff += step;
              advanced = true;
              break;
            }
          }
          if (!advanced) break;
        }
      }

      // ここまでで埋まらない端数が残った場合、最上位ランクの1人あたり額を追加で上げて吸収（多少のオーバーを許容）
      if (diff !== 0) {
        const perPersonBump = Math.ceil(diff / counts[topIdx]);
        if (perPersonBump > 0) {
          pay[topIdx] += perPersonBump;
          diff -= perPersonBump * counts[topIdx];
        }
      }

      // ガード超過なら打ち切り
      if (guard >= GUARD_MAX) {
        throw new Error("丸め調整が収束しませんでした。入力を見直してください。");
      }

      // 最終 subtotal
      let finalTotal = 0;
      for (const i of active) finalTotal += pay[i] * counts[i];

      return { pay, counts, finalTotal, unit, weights, inputTotal: total };
    }

    function renderResult(result) {
      const { pay, counts, finalTotal, inputTotal } = result;

      // テーブル行を作る（人数>0のみ表示）
      const rows = [];
      for (let i = 0; i < counts.length; i++) {
        if (counts[i] <= 0) continue;
        const per = pay[i];
        const sub = per * counts[i];
        rows.push({ rank: i + 1, people: counts[i], per, sub });
      }

      // ランク順で表示
      rows.sort((a, b) => a.rank - b.rank);

      resultBodyEl.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>ランク ${r.rank}</td>
          <td class="num">${yen(r.people)}</td>
          <td class="num"><b>${yen(r.per)}</b></td>
          <td class="num">${yen(r.sub)}</td>
        `;
        resultBodyEl.appendChild(tr);
      }

      sumTextEl.textContent = `合計：${yen(finalTotal)} 円`;
      if (sumNoteEl) {
        if (inputTotal && finalTotal > inputTotal) {
          sumNoteEl.textContent = `入力合計 ${yen(inputTotal)} 円に対し、端数調整のため ${yen(finalTotal)} 円（+${yen(finalTotal - inputTotal)} 円）を徴収します。`;
        } else {
          sumNoteEl.textContent = "丸め単位：" + (roundingBadgeEl ? roundingBadgeEl.textContent.replace(/^丸め単位：/, "") : "") + " ／ 結果はスクリーンショットで保存してください。";
        }
      }
    }

    // ----- イベント -----
    totalEl.addEventListener("focus", () => {
      setTimeout(() => totalEl.select(), 0);
    });
    totalEl.addEventListener("input", () => {
      if (errEl.style.display === "block") showError("");
    });

    document.getElementById("addRank").addEventListener("click", () => {
      if (rankCount >= MAX_RANKS) {
        showError(`ランクは最大 ${MAX_RANKS} までです。`);
        return;
      }
      showError("");
      rankCount += 1;
      renderRanks();
      // 追加直後に新しい行へフォーカスし、見える位置までスクロール
      setTimeout(() => {
        const lastInput = ranksEl.querySelector("input[data-rank]:last-of-type");
        if (lastInput) {
          lastInput.focus();
          lastInput.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }, 0);
    });

    document.getElementById("reset").addEventListener("click", () => {
      rankCount = DEFAULT_RANKS;
      totalEl.value = "";
      slopeEl.value = "normal";
        roundingEl.value = "100";
      renderRanks();
      showError("");
      resultBodyEl.innerHTML = `
        <tr>
          <td colspan="4" style="color: rgba(32,42,80,0.52); font-size: 13px;">
            まだ計算していません。入力して「計算する」を押してください。
          </td>
        </tr>`;
      sumTextEl.textContent = "合計：—";
      resultBoxEl.classList.remove("is-ready");
      updateSlopeBadge(slopeEl.value);
      updateRoundingBadge(Number(roundingEl.value));
      // 画面上部へ（スマホ操作向け）
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.getElementById("calc").addEventListener("click", () => {
      try {
        showError("");

        const total = parseYen(totalEl.value);
        if (!Number.isFinite(total) || total <= 0) {
          throw new Error("合計金額が未入力、または不正です。例：35000 のように入力してください。");
        }
        if (total > 999999999) {
          throw new Error("合計金額が大きすぎます。");
        }

        const counts = readPeopleCounts();
        const roundingUnit = Number(roundingEl.value) || 1;
        if (![1, 100, 1000].includes(roundingUnit)) {
          throw new Error("丸め単位の指定が不正です。");
        }
        const base = SLOPE_BASE[slopeEl.value] ?? SLOPE_BASE.normal;
        const weights = getWeights(base, counts.length);

        const result = compute(total, counts, weights, roundingUnit);

        renderResult(result);
        resultBoxEl.classList.add("is-ready");
        updateSlopeBadge(slopeEl.value);
        updateRoundingBadge(roundingUnit);

        // 結果が見える位置にスクロール（スマホ向け）
        document.getElementById("resultBox").scrollIntoView({ behavior: "smooth", block: "start" });

      } catch (e) {
        showError(e && e.message ? e.message : "エラーが発生しました。入力値を確認してください。");
      }
    });

    // 合計金額は「,」や「円」混じりでもOKにしたいので、入力中に整形はしない（貼り付けも想定）
    // 初期レンダリング
    renderRanks();
    updateSlopeBadge(slopeEl.value);
    updateRoundingBadge(Number(roundingEl.value));
    slopeEl.addEventListener("change", () => updateSlopeBadge(slopeEl.value));
    roundingEl.addEventListener("change", () => updateRoundingBadge(Number(roundingEl.value)));
  </script>
</body>
</html>
